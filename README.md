### Azure Migration to Managed Identity

OpenShift can be configured to use temporary credentials for workload components with [Azure AD Workload Identity](https://azure.github.io/azure-workload-identity/docs/).
In this model, the OpenShift cluster signs Kubernetes ServiceAccount tokens which can be trusted by an external OIDC identity provider. A component such as an operator running on the cluster can exchange the signed ServiceAccount token mounted into its Pod volume for an Azure Active Directory (AD) access token using [Azure Identity SDKs](https://github.com/Azure/azure-sdk-for-go/tree/main/sdk/azidentity). This process also automates requesting and refreshing of credentials. The ServiceAccount token used by a Pod is rotated by the kubelet on the node where Pod is running when the Pod's ServiceAccount token is approaching expiry. ServiceAccount tokens are valid for one hour.


### Steps to run for in-place migration an OpenShift Cluster (OCP >= 4.14.x ) to Azure AD Workload Identity

Steps to run are 
1. Extract the cluster's ServiceAccount public signing key.

   ```bash
   1-Extract-Clusters-ServiceAccount-Public-Signing-Key.sh
   ```

2. Create an output directory for `ccoctl` generated manifests and move the public key file to the output directory.

   ```bash
   2-Create-output-dir-4-ccoctl-Generated-Manifests.sh
   ```

3. Create an OIDC issuer and Azure blob storage container with OIDC configuration files, providing the cluster's existing ServiceAccount public signing key which we extracted.

   Note that an Azure resource group will be created with a name matching the provided `<azure_infra_name>`. An existing Azure resource group can be optionally specified by providing the `--oidc-resource-group-name` parameter.

   Ensure that the region and subscription match that of the existing cluster.

   ```bash
   33-Extract-openshift-install-ccoctl.sh
    3-Create-an-OIDC-Issuer.sh
   ```


4. Extract the OIDC issuer URL from the generated manifests in the output directory and patch the cluster `authentication` config, setting `spec.serviceAccountIssuer`.

   ```bash
      4-Extract-OIDC-issuer-URL-and-patch-cluster-authentication-config.sh
   ```

1. Wait for the kube-apiserver pods to be updated with the new config. This process can take several minutes.

   ```bash
   oc adm wait-for-stable-cluster
   ```

1. Restart all pods (this *will* take a while) in the cluster (because all ServiceAccounts need to be refreshed after updating the serviceAccountIssuer field):

   ```bash
   6-Restart-all-pods.sh
   ```

1. Set the `CloudCredentials`` CR's .spec.credentialsMode to Manual.

   ```bash
   7-PatchCloudCredentialOperatorManualMode.sh
   ```

1. Extract CredentialsCrequests from the cluster's release image for the given version.

   ```bash
      8-Extract-CredentialsCrequests-from-cluster-release-image.sh
   ```

1. Create Managed Identities for each of the CredentialsRequests from the release image.
   ```bash
      9-Create-Managed-Identities-for-each-of-the-CredentialsRequests-from-release-image.sh
   ```
1. Apply the azure pod identity webhook configuration. You may need replace it if the configuration already exists.

   ```bash
      10-Apply-the-azure-pod-identity-webhook-configuration.sh
   ```

1. Apply Secrets generated by the creating managed identities.

   ```bash
      11-Apply-Secrets-generated-by-creating-managed-identities.sh
    ```

1. Wait for the cluster to become stable.

   ```bash
      oc adm wait-for-stable-cluster
   ```

1. At this point the cluster is using Azure AD Workload Identity. The "root" Azure credentials Secret can be removed.

  ```bash
     12-Remove-Azure-Credentials-Secret.sh
  ```
